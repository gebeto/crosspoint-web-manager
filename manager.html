<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CrossPoint Reader - Files</title>
  </head>
  <body>
    <script>
      // get current path from query parameter
      const currentPath = decodeURIComponent(
        new URLSearchParams(window.location.search).get("path") || "/"
      );

      function escapeHtml(unsafe) {
        return unsafe
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB", "TB", "PB", "EB", "ZB", "YB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return (
          parseFloat((bytes / Math.pow(k, i)).toFixed(2)).toLocaleString() +
          " " +
          sizes[i]
        );
      }

      async function hydrate() {
        // Close modals when clicking overlay
        document.querySelectorAll(".modal-overlay").forEach(function (overlay) {
          overlay.addEventListener("click", function (e) {
            if (e.target === overlay) {
              overlay.classList.remove("open");
            }
          });
        });

        const breadcrumbs = document.getElementById("directory-breadcrumbs");
        const fileTable = document.getElementById("file-table");

        let breadcrumbContent = '<span class="sep">/</span>';
        if (currentPath === "/") {
          breadcrumbContent += '<span class="current">üè†</span>';
        } else {
          breadcrumbContent += '<a href="/files">üè†</a>';
          const pathSegments = currentPath.split("/");
          pathSegments
            .slice(1, pathSegments.length - 1)
            .forEach(function (segment, index) {
              breadcrumbContent +=
                '<span class="sep">/</span><a href="/files?path=' +
                encodeURIComponent(pathSegments.slice(0, index + 2).join("/")) +
                '">' +
                escapeHtml(segment) +
                "</a>";
            });
          breadcrumbContent += '<span class="sep">/</span>';
          breadcrumbContent +=
            '<span class="current">' +
            escapeHtml(pathSegments[pathSegments.length - 1]) +
            "</span>";
        }
        breadcrumbs.innerHTML = breadcrumbContent;

        let files = [];
        try {
          const response = await fetch(
            "/api/files?path=" + encodeURIComponent(currentPath)
          );
          if (!response.ok) {
            throw new Error(
              "Failed to load files: " +
                response.status +
                " " +
                response.statusText
            );
          }
          files = await response.json();
        } catch (e) {
          console.error(e);
          fileTable.innerHTML =
            '<div class="no-files">An error occurred while loading the files</div>';
          return;
        }

        let folderCount = 0;
        let totalSize = 0;
        files.forEach((file) => {
          if (file.isDirectory) folderCount++;
          totalSize += file.size;
        });

        document.getElementById(
          "folder-summary"
        ).innerHTML = `${folderCount} folders, ${
          files.length - folderCount
        } files, ${formatFileSize(totalSize)}`;

        if (files.length === 0) {
          fileTable.innerHTML =
            '<div class="no-files">This folder is empty</div>';
        } else {
          let fileTableContent = '<table class="file-table">';
          fileTableContent +=
            '<tr><th>Name</th><th>Type</th><th>Size</th><th class="actions-col">Actions</th></tr>';

          const sortedFiles = files.sort((a, b) => {
            // Directories first, then epub files, then other files, alphabetically within each group
            if (a.isDirectory && !b.isDirectory) return -1;
            if (!a.isDirectory && b.isDirectory) return 1;
            if (a.isEpub && !b.isEpub) return -1;
            if (!a.isEpub && b.isEpub) return 1;
            return a.name.localeCompare(b.name);
          });

          sortedFiles.forEach((file) => {
            if (file.isDirectory) {
              let folderPath = currentPath;
              if (!folderPath.endsWith("/")) folderPath += "/";
              folderPath += file.name;

              fileTableContent += '<tr class="folder-row">';
              fileTableContent += `<td><span class="file-icon">üìÅ</span><a href="/files?path=${encodeURIComponent(
                folderPath
              )}" class="folder-link">${escapeHtml(
                file.name
              )}</a><span class="folder-badge">FOLDER</span></td>`;
              fileTableContent += "<td>Folder</td>";
              fileTableContent += "<td>-</td>";
              fileTableContent += `<td class="actions-col"><button class="delete-btn" onclick="openDeleteModal('${file.name.replaceAll(
                "'",
                "\\'"
              )}', '${folderPath.replaceAll(
                "'",
                "\\'"
              )}', true)" title="Delete folder">üóëÔ∏è</button></td>`;
              fileTableContent += "</tr>";
            } else {
              let filePath = currentPath;
              if (!filePath.endsWith("/")) filePath += "/";
              filePath += file.name;

              fileTableContent += `<tr class="${
                file.isEpub ? "epub-file" : ""
              }">`;
              fileTableContent += `<td><span class="file-icon">${
                file.isEpub ? "üìó" : "üìÑ"
              }</span>${escapeHtml(file.name)}`;
              if (file.isEpub)
                fileTableContent += '<span class="epub-badge">EPUB</span>';
              fileTableContent += "</td>";
              fileTableContent += `<td>${file.name
                .split(".")
                .pop()
                .toUpperCase()}</td>`;
              fileTableContent += `<td>${formatFileSize(file.size)}</td>`;
              fileTableContent += `<td class="actions-col"><button class="delete-btn" onclick="openDeleteModal('${file.name.replaceAll(
                "'",
                "\\'"
              )}', '${filePath.replaceAll(
                "'",
                "\\'"
              )}', false)" title="Delete file">üóëÔ∏è</button></td>`;
              fileTableContent += "</tr>";
            }
          });

          fileTableContent += "</table>";
          fileTable.innerHTML = fileTableContent;
        }
      }

      // Modal functions
      function openUploadModal() {
        document.getElementById("uploadPathDisplay").textContent =
          currentPath === "/" ? "/ üè†" : currentPath;
        document.getElementById("uploadModal").classList.add("open");
      }

      function closeUploadModal() {
        document.getElementById("uploadModal").classList.remove("open");
        document.getElementById("fileInput").value = "";
        document.getElementById("uploadBtn").disabled = true;
        document.getElementById("progress-container").style.display = "none";
        document.getElementById("progress-fill").style.width = "0%";
        document.getElementById("progress-fill").style.backgroundColor =
          "#27ae60";
      }

      function openFolderModal() {
        document.getElementById("folderPathDisplay").textContent =
          currentPath === "/" ? "/ üè†" : currentPath;
        document.getElementById("folderModal").classList.add("open");
        document.getElementById("folderName").value = "";
      }

      function closeFolderModal() {
        document.getElementById("folderModal").classList.remove("open");
      }

      function validateFile() {
        const fileInput = document.getElementById("fileInput");
        const uploadBtn = document.getElementById("uploadBtn");
        const file = fileInput.files[0];
        uploadBtn.disabled = !file;
      }

      function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select a file first!");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);

        const progressContainer = document.getElementById("progress-container");
        const progressFill = document.getElementById("progress-fill");
        const progressText = document.getElementById("progress-text");
        const uploadBtn = document.getElementById("uploadBtn");

        progressContainer.style.display = "block";
        uploadBtn.disabled = true;

        const xhr = new XMLHttpRequest();
        // Include path as query parameter since multipart form data doesn't make
        // form fields available until after file upload completes
        xhr.open(
          "POST",
          "/upload?path=" + encodeURIComponent(currentPath),
          true
        );

        xhr.upload.onprogress = function (e) {
          if (e.lengthComputable) {
            const percent = Math.round((e.loaded / e.total) * 100);
            progressFill.style.width = percent + "%";
            progressText.textContent = "Uploading: " + percent + "%";
          }
        };

        xhr.onload = function () {
          if (xhr.status === 200) {
            progressText.textContent = "Upload complete!";
            setTimeout(function () {
              window.location.reload();
            }, 1000);
          } else {
            progressText.textContent = "Upload failed: " + xhr.responseText;
            progressFill.style.backgroundColor = "#e74c3c";
            uploadBtn.disabled = false;
          }
        };

        xhr.onerror = function () {
          progressText.textContent = "Upload failed - network error";
          progressFill.style.backgroundColor = "#e74c3c";
          uploadBtn.disabled = false;
        };

        xhr.send(formData);
      }

      function createFolder() {
        const folderName = document.getElementById("folderName").value.trim();

        if (!folderName) {
          alert("Please enter a folder name!");
          return;
        }

        // Validate folder name (no special characters except underscore and hyphen)
        const validName = /^[a-zA-Z0-9_\-]+$/.test(folderName);
        if (!validName) {
          alert(
            "Folder name can only contain letters, numbers, underscores, and hyphens."
          );
          return;
        }

        const formData = new FormData();
        formData.append("name", folderName);
        formData.append("path", currentPath);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/mkdir", true);

        xhr.onload = function () {
          if (xhr.status === 200) {
            window.location.reload();
          } else {
            alert("Failed to create folder: " + xhr.responseText);
          }
        };

        xhr.onerror = function () {
          alert("Failed to create folder - network error");
        };

        xhr.send(formData);
      }

      // Delete functions
      function openDeleteModal(name, path, isFolder) {
        document.getElementById("deleteItemName").textContent =
          (isFolder ? "üìÅ " : "üìÑ ") + name;
        document.getElementById("deleteItemPath").value = path;
        document.getElementById("deleteItemType").value = isFolder
          ? "folder"
          : "file";
        document.getElementById("deleteModal").classList.add("open");
      }

      function closeDeleteModal() {
        document.getElementById("deleteModal").classList.remove("open");
      }

      function confirmDelete() {
        const path = document.getElementById("deleteItemPath").value;
        const itemType = document.getElementById("deleteItemType").value;

        const formData = new FormData();
        formData.append("path", path);
        formData.append("type", itemType);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/delete", true);

        xhr.onload = function () {
          if (xhr.status === 200) {
            window.location.reload();
          } else {
            alert("Failed to delete: " + xhr.responseText);
            closeDeleteModal();
          }
        };

        xhr.onerror = function () {
          alert("Failed to delete - network error");
          closeDeleteModal();
        };

        xhr.send(formData);
      }

      hydrate();
    </script>
  </body>
</html>
